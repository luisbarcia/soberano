{{/* layouts/_markup/render-image.html */}}
{{/* Render hook for images in Markdown: ![alt](src "title")               */}}
{{/* If the image is a Page Resource, process with WebP + srcset.          */}}
{{/* If the image is external, render as-is with lazy loading.             */}}
{{/* URL scheme validation prevents javascript:/data: vectors.             */}}

{{ $img := .Page.Resources.GetMatch .Destination }}
{{ if $img }}
  {{/* Image is a Page Resource — full processing */}}
  <figure>
    {{ partial "components/picture.html" (dict
      "img"     $img
      "alt"     .Text
      "loading" "lazy"
    ) }}
    {{ with .Title }}
    <figcaption>{{ . }}</figcaption>
    {{ end }}
  </figure>
{{ else }}
  {{/* External image or static path — validate scheme then render */}}
  {{ $url := .Destination }}
  {{ $isSafe := or (hasPrefix $url "http://") (hasPrefix $url "https://") (hasPrefix $url "//") (hasPrefix $url "/") }}
  {{ if not (strings.Contains $url ":") }}{{ $isSafe = true }}{{ end }}
  <figure>
    <img
      src="{{ if $isSafe }}{{ $url | safeURL }}{{ else }}#blocked-url{{ end }}"
      alt="{{ .Text }}"
      loading="lazy"
      decoding="async"
    >
    {{ with .Title }}
    <figcaption>{{ . }}</figcaption>
    {{ end }}
  </figure>
{{ end }}
